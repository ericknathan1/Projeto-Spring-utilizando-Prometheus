<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stockflow - Painel de Teste de Carga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Animação para logs novos */
        .log-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-badge {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-6">

    <!-- Header -->
    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                <i class="fa-solid fa-chart-line mr-2"></i>Stockflow Tester
            </h1>
            <p class="text-slate-400 text-sm mt-1">Ferramenta de geração de métricas para Prometheus/Grafana</p>
        </div>
        
        <div class="flex items-center gap-2 bg-slate-800 p-2 rounded-lg border border-slate-700">
            <span class="text-xs text-slate-400 font-mono">API URL:</span>
            <input type="text" id="apiUrl" value="http://localhost:8080" class="bg-transparent border-none focus:ring-0 text-sm font-mono text-green-400 w-48 placeholder-slate-600" placeholder="http://localhost:8080">
            <div id="connectionStatus" class="w-3 h-3 rounded-full bg-red-500 transition-colors" title="Status da Conexão"></div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Coluna Esquerda: Controles -->
        <div class="lg:col-span-1 space-y-6">
            
            <!-- Painel de Setup -->
            <div class="bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-lg">
                <h2 class="text-lg font-semibold mb-4 text-white flex items-center">
                    <i class="fa-solid fa-play text-blue-400 mr-2"></i> Setup Inicial
                </h2>
                <p class="text-slate-400 text-sm mb-4">Cria o evento e repõe o estoque para 100 ingressos.</p>
                <button onclick="iniciarEvento()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 px-4 rounded-lg transition-all active:scale-95 flex justify-center items-center gap-2">
                    <i class="fa-solid fa-rocket"></i> Iniciar / Resetar Evento
                </button>
            </div>

            <!-- Painel de Compra Manual -->
            <div class="bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-lg">
                <h2 class="text-lg font-semibold mb-4 text-white flex items-center">
                    <i class="fa-solid fa-cart-shopping text-green-400 mr-2"></i> Compra Manual
                </h2>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-slate-400">Email</label>
                        <input type="email" id="manualEmail" value="cliente@teste.com" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white focus:border-blue-500 outline-none transition-colors">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">Tipo de Ingresso</label>
                        <select id="manualTipo" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white focus:border-blue-500 outline-none transition-colors">
                            <option value="PISTA">PISTA</option>
                            <option value="VIP">VIP</option>
                            <option value="CAMAROTE">CAMAROTE</option>
                        </select>
                    </div>
                    <button onclick="comprarManual()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-4 rounded-lg transition-all active:scale-95 border border-slate-600">
                        Comprar (1x)
                    </button>
                </div>
            </div>

            <!-- Painel de Carga Automática -->
            <div class="bg-slate-800 rounded-xl p-5 border border-purple-500/30 shadow-lg relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-10">
                    <i class="fa-solid fa-robot text-6xl text-purple-500"></i>
                </div>
                <h2 class="text-lg font-semibold mb-2 text-white flex items-center">
                    <i class="fa-solid fa-bolt text-yellow-400 mr-2"></i> Gerador de Tráfego
                </h2>
                <p class="text-xs text-slate-400 mb-4">Simula múltiplos usuários comprando aleatoriamente. Ideal para ver os gráficos mexerem.</p>
                
                <div class="flex items-center justify-between mb-4 bg-slate-900 p-2 rounded border border-slate-700">
                    <span class="text-xs text-slate-300">Velocidade:</span>
                    <select id="speed" class="bg-transparent text-xs text-purple-400 font-bold outline-none cursor-pointer">
                        <option value="1000">Lento (1 req/s)</option>
                        <option value="500">Médio (2 req/s)</option>
                        <option value="100" selected>Rápido (10 req/s)</option>
                        <option value="10">Insano (100 req/s)</option>
                    </select>
                </div>

                <button id="btnAuto" onclick="toggleAuto()" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-lg transition-all active:scale-95 shadow-lg shadow-purple-900/50 flex justify-center items-center gap-2">
                    <i class="fa-solid fa-play"></i> INICIAR CARGA
                </button>
            </div>
        </div>

        <!-- Coluna Direita: Logs e Status -->
        <div class="lg:col-span-2 flex flex-col gap-6">
            
            <!-- Dashboard Rápido -->
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center">
                    <span class="text-xs text-slate-400 uppercase tracking-wider">Sucesso (200)</span>
                    <span id="countSuccess" class="text-2xl font-bold text-green-400">0</span>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center">
                    <span class="text-xs text-slate-400 uppercase tracking-wider">Erros (500/4xx)</span>
                    <span id="countError" class="text-2xl font-bold text-red-400">0</span>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center">
                    <span class="text-xs text-slate-400 uppercase tracking-wider">Requisições</span>
                    <span id="countTotal" class="text-2xl font-bold text-blue-400">0</span>
                </div>
            </div>

            <!-- Terminal de Logs -->
            <div class="flex-1 bg-black rounded-xl border border-slate-700 overflow-hidden flex flex-col shadow-2xl">
                <div class="bg-slate-900 px-4 py-2 border-b border-slate-700 flex justify-between items-center">
                    <span class="text-xs font-mono text-slate-400"><i class="fa-solid fa-terminal mr-2"></i>Console de Saída</span>
                    <button onclick="clearLogs()" class="text-xs text-slate-500 hover:text-white transition-colors">Limpar</button>
                </div>
                <div id="consoleOutput" class="flex-1 p-4 overflow-y-auto font-mono text-xs space-y-2 max-h-[400px]">
                    <div class="text-slate-500 italic">Pronto para iniciar. Aguardando comandos...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado
        let isRunning = false;
        let intervalId = null;
        let stats = { success: 0, error: 0, total: 0 };
        const types = ['PISTA', 'VIP', 'CAMAROTE'];
        const emails = ['joao@email.com', 'maria@email.com', 'pedro@email.com', 'ana@teste.com', 'dev@senac.br'];

        // Elementos DOM
        const consoleEl = document.getElementById('consoleOutput');
        const btnAuto = document.getElementById('btnAuto');
        
        // Utilitários
        const getUrl = (path) => {
            const base = document.getElementById('apiUrl').value.replace(/\/$/, '');
            return `${base}${path}`;
        }

        const log = (msg, type = 'info') => {
            const div = document.createElement('div');
            div.className = 'log-enter flex items-start gap-2 border-l-2 pl-2 py-1';
            
            const time = new Date().toLocaleTimeString();
            
            if (type === 'success') {
                div.classList.add('border-green-500', 'text-green-300');
                div.innerHTML = `<span class="text-slate-500">[${time}]</span> <i class="fa-solid fa-check mt-1 text-[10px]"></i> <span>${msg}</span>`;
            } else if (type === 'error') {
                div.classList.add('border-red-500', 'text-red-300');
                div.innerHTML = `<span class="text-slate-500">[${time}]</span> <i class="fa-solid fa-triangle-exclamation mt-1 text-[10px]"></i> <span>${msg}</span>`;
            } else {
                div.classList.add('border-blue-500', 'text-blue-300');
                div.innerHTML = `<span class="text-slate-500">[${time}]</span> <i class="fa-solid fa-info-circle mt-1 text-[10px]"></i> <span>${msg}</span>`;
            }

            consoleEl.prepend(div);
            // Manter apenas ultimos 50 logs para performance
            if (consoleEl.children.length > 50) {
                consoleEl.lastElementChild.remove();
            }
        };

        const updateStats = (isSuccess) => {
            stats.total++;
            if (isSuccess) stats.success++;
            else stats.error++;

            document.getElementById('countSuccess').innerText = stats.success;
            document.getElementById('countError').innerText = stats.error;
            document.getElementById('countTotal').innerText = stats.total;
        };

        const clearLogs = () => {
            consoleEl.innerHTML = '';
            stats = { success: 0, error: 0, total: 0 };
            updateStats(true); // refresh UI reset
            // Hack to reset counters cleanly visual
            document.getElementById('countSuccess').innerText = 0;
            document.getElementById('countError').innerText = 0;
            document.getElementById('countTotal').innerText = 0;
        };

        // Ações da API
        async function iniciarEvento() {
            log('Iniciando evento (/start)...', 'info');
            try {
                const res = await fetch(getUrl('/start'), { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    log(`Evento Criado! Estoque: ${data.estoqueDisponivel}`, 'success');
                    // Reset stats visualmente para nova rodada
                    stats = { success: 0, error: 0, total: 0 }; 
                } else {
                    log(`Erro ao iniciar: ${res.status}`, 'error');
                }
            } catch (e) {
                log(`Falha na conexão: ${e.message}`, 'error');
                checkConnection(false);
            }
        }

        async function comprarManual() {
            const email = document.getElementById('manualEmail').value;
            const tipo = document.getElementById('manualTipo').value;
            await realizarCompra(email, tipo);
        }

        async function realizarCompra(email, tipo) {
            try {
                const body = { eventoId: 1, email, tipo };
                const res = await fetch(getUrl('/comprar'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    const data = await res.json();
                    log(`Compra OK: ${data.id} (${data.tipo})`, 'success');
                    updateStats(true);
                } else {
                    const txt = await res.text();
                    log(`Falha: ${txt || res.statusText}`, 'error');
                    updateStats(false);
                }
            } catch (e) {
                log(`Erro de Rede: ${e.message}`, 'error');
                updateStats(false);
            }
        }

        // Automação
        function toggleAuto() {
            if (isRunning) {
                // Parar
                clearInterval(intervalId);
                isRunning = false;
                btnAuto.innerHTML = '<i class="fa-solid fa-play"></i> INICIAR CARGA';
                btnAuto.classList.replace('bg-red-600', 'bg-purple-600');
                btnAuto.classList.replace('hover:bg-red-500', 'hover:bg-purple-500');
                log('Gerador de tráfego PAUSADO.', 'info');
            } else {
                // Iniciar
                const speed = document.getElementById('speed').value;
                isRunning = true;
                btnAuto.innerHTML = '<i class="fa-solid fa-stop"></i> PARAR CARGA';
                btnAuto.classList.replace('bg-purple-600', 'bg-red-600');
                btnAuto.classList.replace('hover:bg-purple-500', 'hover:bg-red-500');
                log(`Gerador INICIADO (${speed}ms de intervalo).`, 'info');

                intervalId = setInterval(() => {
                    const randomEmail = emails[Math.floor(Math.random() * emails.length)];
                    const randomTipo = types[Math.floor(Math.random() * types.length)];
                    realizarCompra(randomEmail, randomTipo);
                }, speed);
            }
        }

        // Checagem simples de conexão
        function checkConnection(status) {
            const el = document.getElementById('connectionStatus');
            if(status) el.classList.replace('bg-red-500', 'bg-green-500');
            else el.classList.replace('bg-green-500', 'bg-red-500');
        }
        
        // Tenta pingar o health check ao carregar
        window.onload = async () => {
            try {
                const res = await fetch(getUrl('/actuator/health'));
                if(res.ok) {
                    checkConnection(true);
                    log('Conectado à API com sucesso.', 'success');
                } else {
                    checkConnection(false);
                }
            } catch(e) {
                checkConnection(false);
                log('Não foi possível conectar à API. Verifique o CORS.', 'error');
            }
        };

    </script>
</body>
</html>